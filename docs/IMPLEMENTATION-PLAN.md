# íŒì—… ì •ì±… ë¦¬íŒ©í† ë§ êµ¬í˜„ ê³„íš

**ì‘ì„±ì¼**: 2025-11-09  
**ëª©ì **: 3ê°œ í…Œì´ë¸” ë¶„ë¦¬ ë° ì¶”ì  ë°©ì‹ ê°œì„   
**ì˜ˆìƒ ê¸°ê°„**: 3-5ì¼  
**ë‚œì´ë„**: ì¤‘ê¸‰

---

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ ê°œìš”](#ì „ì²´-ê°œìš”)
2. [í˜„ì¬ ìƒíƒœ](#í˜„ì¬-ìƒíƒœ)
3. [ëª©í‘œ ìƒíƒœ](#ëª©í‘œ-ìƒíƒœ)
4. [ë‹¨ê³„ë³„ êµ¬í˜„ ê³„íš](#ë‹¨ê³„ë³„-êµ¬í˜„-ê³„íš)
5. [ì²´í¬ë¦¬ìŠ¤íŠ¸](#ì²´í¬ë¦¬ìŠ¤íŠ¸)
6. [ë¡¤ë°± ê³„íš](#ë¡¤ë°±-ê³„íš)

---

## ğŸ¯ ì „ì²´ ê°œìš”

### í•µì‹¬ ë³€ê²½ì‚¬í•­

```
Before (1ê°œ í…Œì´ë¸”):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        app_policy               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ emergency (active_popup_type) â”‚
â”‚ â€¢ force_update                  â”‚
â”‚ â€¢ optional_update               â”‚
â”‚ â€¢ notice                        â”‚
â”‚ â€¢ ad_control (ê´‘ê³  ì •ì±…)        â”‚
â”‚                                 â”‚
â”‚ min_supported_version âŒ        â”‚
â”‚ latest_version_code âŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After (3ê°œ í…Œì´ë¸” + ê´‘ê³ ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ update_policy    â”‚  â”‚ notice_policy    â”‚  â”‚ emergency_policy â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì—…ë°ì´íŠ¸ ì „ìš©    â”‚  â”‚ ê³µì§€ ì „ìš©        â”‚  â”‚ ê¸´ê¸‰ ì „ìš©        â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚ target_version âœ…â”‚  â”‚ notice_version âœ…â”‚  â”‚ is_dismissible âœ…â”‚
â”‚ is_force_update âœ…â”‚  â”‚                  â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

app_policy â†’ ê´‘ê³  ì •ì±… ì „ìš© (ë˜ëŠ” ì œê±°)
```

---

## ğŸ“Š í˜„ì¬ ìƒíƒœ

### ê¸°ì¡´ êµ¬ì¡°

```kotlin
// AppPolicy.kt (í˜„ì¬)
data class AppPolicy(
    val activePopupType: String,  // 'emergency', 'force_update', 'optional_update', 'notice', 'none'
    val minSupportedVersion: Int?,  // ê°•ì œ ì—…ë°ì´íŠ¸ìš©
    val latestVersionCode: Int?,    // ì„ íƒì  ì—…ë°ì´íŠ¸ìš©
    val content: String?,
    // ... ê´‘ê³  ê´€ë ¨ í•„ë“œë“¤
)
```

### í˜„ì¬ ë¬¸ì œì 

1. âŒ **ì±…ì„ ê³¼ë‹¤**: 1ê°œ í…Œì´ë¸”ì´ ëª¨ë“  íŒì—… ë‹´ë‹¹
2. âŒ **í•„ë“œëª… í˜¼ë€**: min_supported vs latest_version
3. âŒ **ì¶”ì  ë¶ˆê°€**: noticeëŠ” id ê¸°ë°˜ (ì¬í‘œì‹œ ì•ˆ ë¨)
4. âŒ **Google Play ìœ„ë°˜ ê°€ëŠ¥**: emergency X ë²„íŠ¼ ì˜µì…˜ ì—†ìŒ

---

## ğŸ¯ ëª©í‘œ ìƒíƒœ

### ìƒˆë¡œìš´ êµ¬ì¡°

```kotlin
// UpdatePolicy.kt (ì‹ ê·œ)
data class UpdatePolicy(
    val targetVersionCode: Int,      // ë‹¨ì¼ í•„ë“œ!
    val isForceUpdate: Boolean,      // ê°•ì œ ì—¬ë¶€
    val message: String?,
    val releaseNotes: String?
)

// NoticePolicy.kt (ì‹ ê·œ)
data class NoticePolicy(
    val title: String?,
    val content: String,
    val noticeVersion: Int,          // ë²„ì „ ê´€ë¦¬!
    val imageUrl: String?,
    val actionUrl: String?
)

// EmergencyPolicy.kt (ì‹ ê·œ)
data class EmergencyPolicy(
    val content: String,
    val redirectUrl: String?,
    val isDismissible: Boolean       // Google Play ì¤€ìˆ˜!
)
```

### ê°œì„  ì‚¬í•­

1. âœ… **ì±…ì„ ë¶„ë¦¬**: ê° í…Œì´ë¸”ì´ ë‹¨ì¼ ì±…ì„
2. âœ… **í•„ë“œ ë‹¨ìˆœí™”**: target_version í•˜ë‚˜ë¡œ í†µì¼
3. âœ… **ì¶”ì  ê°œì„ **: notice_versionìœ¼ë¡œ ëª…ì‹œì  ê´€ë¦¬
4. âœ… **ì •ì±… ì¤€ìˆ˜**: is_dismissibleë¡œ Google Play ì¤€ìˆ˜

---

## ğŸ“… ë‹¨ê³„ë³„ êµ¬í˜„ ê³„íš

### ğŸ”µ Phase 1: update_policy í…Œì´ë¸” ìƒì„± (1ì¼)

**ëª©í‘œ**: ì—…ë°ì´íŠ¸ ì •ì±… ë¶„ë¦¬ ë° ë‹¨ìˆœí™”

#### 1-1. Supabase ì‘ì—… (30ë¶„)

```sql
-- 1. update_policy í…Œì´ë¸” ìƒì„±
CREATE TABLE public.update_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- í•µì‹¬ í•„ë“œ
    target_version_code INT NOT NULL,
    is_force_update BOOLEAN NOT NULL,
    
    -- ë¶€ê°€ ì •ë³´
    message TEXT,
    release_notes TEXT,
    download_url TEXT,
    
    CONSTRAINT update_policy_pkey PRIMARY KEY (id),
    CONSTRAINT update_policy_unique_active 
        UNIQUE (app_id, is_active) 
        WHERE is_active = true
);

-- 2. ì¸ë±ìŠ¤
CREATE INDEX idx_update_policy_app_id ON public.update_policy(app_id);
CREATE INDEX idx_update_policy_active ON public.update_policy(is_active);

-- 3. RLS ì •ì±…
ALTER TABLE public.update_policy ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allow_read_update_policy"
ON public.update_policy
FOR SELECT
USING (true);

-- 4. ì½”ë©˜íŠ¸
COMMENT ON TABLE public.update_policy IS 'ì•± ì—…ë°ì´íŠ¸ ì •ì±… (ê°•ì œ/ì„ íƒì  ì—…ë°ì´íŠ¸)';
COMMENT ON COLUMN public.update_policy.target_version_code IS 'ëª©í‘œ ë²„ì „ ì½”ë“œ (í˜„ì¬ ë²„ì „ < ëª©í‘œ ë²„ì „ì´ë©´ ì—…ë°ì´íŠ¸ í•„ìš”)';
COMMENT ON COLUMN public.update_policy.is_force_update IS 'ê°•ì œ ì—…ë°ì´íŠ¸ ì—¬ë¶€ (true: ê°•ì œ, false: ì„ íƒì )';
```

#### 1-2. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (10ë¶„)

```sql
-- app_policyì—ì„œ update_policyë¡œ ë°ì´í„° ë³µì‚¬
INSERT INTO update_policy (app_id, is_active, target_version_code, is_force_update, message, download_url)
SELECT 
    app_id,
    is_active,
    COALESCE(min_supported_version, latest_version_code, 1) as target_version_code,
    CASE WHEN active_popup_type = 'force_update' THEN true ELSE false END as is_force_update,
    content as message,
    download_url
FROM app_policy
WHERE active_popup_type IN ('force_update', 'optional_update')
  AND (min_supported_version IS NOT NULL OR latest_version_code IS NOT NULL);
```

#### 1-3. Kotlin ëª¨ë¸ ìƒì„± (30ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/model/UpdatePolicy.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class UpdatePolicy(
    @SerialName("id")
    val id: Long? = null,

    @SerialName("created_at")
    val createdAt: String? = null,

    @SerialName("app_id")
    val appId: String,

    @SerialName("is_active")
    val isActive: Boolean = false,

    // í•µì‹¬ í•„ë“œ (ë‹¨ìˆœí™”!)
    @SerialName("target_version_code")
    val targetVersionCode: Int,

    @SerialName("is_force_update")
    val isForceUpdate: Boolean,

    // ë¶€ê°€ ì •ë³´
    @SerialName("message")
    val message: String? = null,

    @SerialName("release_notes")
    val releaseNotes: String? = null,

    @SerialName("download_url")
    val downloadUrl: String? = null
) {
    /**
     * ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œì§€ í™•ì¸
     */
    fun needsUpdate(currentVersionCode: Int): Boolean {
        return currentVersionCode < targetVersionCode
    }

    /**
     * ê°•ì œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œì§€ í™•ì¸
     */
    fun requiresForceUpdate(currentVersionCode: Int): Boolean {
        return isForceUpdate && needsUpdate(currentVersionCode)
    }

    /**
     * ì„ íƒì  ì—…ë°ì´íŠ¸ ê¶Œì¥ ì—¬ë¶€
     */
    fun recommendsOptionalUpdate(currentVersionCode: Int): Boolean {
        return !isForceUpdate && needsUpdate(currentVersionCode)
    }
}
```

#### 1-4. Repository ìƒì„± (30ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/repository/UpdatePolicyRepository.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.repository

import com.sweetapps.pocketchord.data.supabase.model.UpdatePolicy
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from

class UpdatePolicyRepository(
    private val client: SupabaseClient,
    private val appId: String = com.sweetapps.pocketchord.BuildConfig.SUPABASE_APP_ID
) {
    /**
     * í™œì„± ì—…ë°ì´íŠ¸ ì •ì±… ì¡°íšŒ
     */
    suspend fun getPolicy(): Result<UpdatePolicy?> = runCatching {
        client.from("update_policy")
            .select()
            .decodeList<UpdatePolicy>()
            .find { it.appId == appId && it.isActive }
    }
}
```

#### 1-5. HomeScreen í†µí•© (1-2ì‹œê°„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/ui/screens/HomeScreen.kt`

```kotlin
// ê¸°ì¡´ AppPolicyRepository ëŒ€ì‹  UpdatePolicyRepository ì‚¬ìš©
val updatePolicyRepo = remember { UpdatePolicyRepository(supabaseClient) }

LaunchedEffect(Unit) {
    // 1. Emergency í™•ì¸ (ì¶”í›„ êµ¬í˜„)
    
    // 2. Update í™•ì¸ (ì‹ ê·œ)
    updatePolicyRepo.getPolicy()
        .onSuccess { policy ->
            policy?.let { p ->
                when {
                    p.requiresForceUpdate(currentVersion) -> {
                        updateInfo = UpdateInfo(
                            versionCode = p.targetVersionCode,
                            isForce = true,
                            releaseNotes = p.releaseNotes ?: p.message ?: "",
                            downloadUrl = p.downloadUrl
                        )
                        showUpdateDialog = true
                    }
                    p.recommendsOptionalUpdate(currentVersion) && 
                        dismissedVersionCode.value != p.targetVersionCode -> {
                        updateInfo = UpdateInfo(
                            versionCode = p.targetVersionCode,
                            isForce = false,
                            releaseNotes = p.releaseNotes ?: p.message ?: "",
                            downloadUrl = p.downloadUrl
                        )
                        showUpdateDialog = true
                    }
                }
            }
        }
        .onFailure { e ->
            Log.e("HomeScreen", "Failed to load update policy", e)
        }
    
    // 3. Notice í™•ì¸ (ì¶”í›„ êµ¬í˜„)
}
```

#### 1-6. í…ŒìŠ¤íŠ¸ (1ì‹œê°„)

- [ ] ê°•ì œ ì—…ë°ì´íŠ¸ íŒì—… í‘œì‹œ í™•ì¸
- [ ] ì„ íƒì  ì—…ë°ì´íŠ¸ íŒì—… í‘œì‹œ í™•ì¸
- [ ] "ë‚˜ì¤‘ì—" ë²„íŠ¼ ë™ì‘ í™•ì¸
- [ ] ë²„ì „ ì¡°ê±´ í…ŒìŠ¤íŠ¸ (í˜„ì¬ < ëª©í‘œ)
- [ ] ì˜¤í”„ë¼ì¸ ìºì‹œ ë™ì‘ í™•ì¸

---

### ğŸŸ¢ Phase 2: emergency_policy í…Œì´ë¸” ìƒì„± (1ì¼)

**ëª©í‘œ**: ê¸´ê¸‰ ìƒí™© ë¶„ë¦¬ ë° Google Play ì •ì±… ì¤€ìˆ˜

#### 2-1. Supabase ì‘ì—… (30ë¶„)

```sql
-- 1. emergency_policy í…Œì´ë¸” ìƒì„±
CREATE TABLE public.emergency_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- ê¸´ê¸‰ ë©”ì‹œì§€
    content TEXT NOT NULL,
    redirect_url TEXT,
    new_app_id TEXT,
    
    -- Google Play ì •ì±… ì¤€ìˆ˜
    is_dismissible BOOLEAN NOT NULL DEFAULT TRUE,
    
    CONSTRAINT emergency_policy_pkey PRIMARY KEY (id),
    CONSTRAINT emergency_policy_unique_active 
        UNIQUE (app_id, is_active) 
        WHERE is_active = true
);

-- 2. ì¸ë±ìŠ¤
CREATE INDEX idx_emergency_policy_app_id ON public.emergency_policy(app_id);
CREATE INDEX idx_emergency_policy_active ON public.emergency_policy(is_active);

-- 3. RLS ì •ì±…
ALTER TABLE public.emergency_policy ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allow_read_emergency_policy"
ON public.emergency_policy
FOR SELECT
USING (true);

-- 4. ì½”ë©˜íŠ¸
COMMENT ON TABLE public.emergency_policy IS 'ê¸´ê¸‰ ìƒí™© íŒì—… ì •ì±… (ì•± ì°¨ë‹¨, ì„œë¹„ìŠ¤ ì¢…ë£Œ ë“±)';
COMMENT ON COLUMN public.emergency_policy.is_dismissible IS 'X ë²„íŠ¼ í—ˆìš© ì—¬ë¶€ (ê¸°ë³¸ê°’ true, falseëŠ” ìµœí›„ì˜ ìˆ˜ë‹¨)';
```

#### 2-2. Kotlin ëª¨ë¸ ìƒì„± (20ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/model/EmergencyPolicy.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class EmergencyPolicy(
    @SerialName("id")
    val id: Long? = null,

    @SerialName("created_at")
    val createdAt: String? = null,

    @SerialName("app_id")
    val appId: String,

    @SerialName("is_active")
    val isActive: Boolean = false,

    @SerialName("content")
    val content: String,

    @SerialName("redirect_url")
    val redirectUrl: String? = null,

    @SerialName("new_app_id")
    val newAppId: String? = null,

    @SerialName("is_dismissible")
    val isDismissible: Boolean = true
)
```

#### 2-3. Repository ìƒì„± (20ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/repository/EmergencyPolicyRepository.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.repository

import com.sweetapps.pocketchord.data.supabase.model.EmergencyPolicy
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from

class EmergencyPolicyRepository(
    private val client: SupabaseClient,
    private val appId: String = com.sweetapps.pocketchord.BuildConfig.SUPABASE_APP_ID
) {
    /**
     * í™œì„± ê¸´ê¸‰ ì •ì±… ì¡°íšŒ
     */
    suspend fun getActiveEmergency(): Result<EmergencyPolicy?> = runCatching {
        client.from("emergency_policy")
            .select()
            .decodeList<EmergencyPolicy>()
            .find { it.appId == appId && it.isActive }
    }
}
```

#### 2-4. HomeScreen í†µí•© (1ì‹œê°„)

```kotlin
// ìš°ì„ ìˆœìœ„ 1: Emergency í™•ì¸
val emergencyRepo = remember { EmergencyPolicyRepository(supabaseClient) }

LaunchedEffect(Unit) {
    // 1. Emergency í™•ì¸ (ìµœìš°ì„ !)
    emergencyRepo.getActiveEmergency()
        .onSuccess { emergency ->
            emergency?.let {
                appPolicy = it  // EmergencyPolicyë¡œ íƒ€ì… ë³€ê²½ í•„ìš”
                showEmergencyDialog = true
                return@LaunchedEffect  // ê¸´ê¸‰ ìƒí™©ì´ë©´ ë‹¤ë¥¸ íŒì—… í‘œì‹œ ì•ˆ í•¨
            }
        }
        .onFailure { e ->
            Log.e("HomeScreen", "Failed to load emergency policy", e)
        }
    
    // 2. Update í™•ì¸
    // ...
}

// EmergencyRedirectDialog ìˆ˜ì •
if (showEmergencyDialog && appPolicy != null) {
    EmergencyRedirectDialog(
        title = "ğŸš¨ ê¸´ê¸‰ê³µì§€",
        description = appPolicy!!.content,
        redirectUrl = appPolicy!!.redirectUrl,
        isDismissible = appPolicy!!.isDismissible,  // â† DBì—ì„œ ì œì–´!
        onDismiss = if (appPolicy!!.isDismissible) {
            { showEmergencyDialog = false }
        } else null,
        badgeText = "ê¸´ê¸‰"
    )
}
```

#### 2-5. í…ŒìŠ¤íŠ¸ (1ì‹œê°„)

- [ ] emergency íŒì—… í‘œì‹œ í™•ì¸
- [ ] is_dismissible=true ì‹œ X ë²„íŠ¼ í‘œì‹œ í™•ì¸
- [ ] is_dismissible=false ì‹œ X ë²„íŠ¼ ìˆ¨ê¹€ í™•ì¸
- [ ] ìš°ì„ ìˆœìœ„ í™•ì¸ (emergency > update)
- [ ] ì¶”ì  ì—†ìŒ í™•ì¸ (ë§¤ë²ˆ í‘œì‹œ)

---

### ğŸŸ¡ Phase 3: notice_policy í…Œì´ë¸” ìƒì„± (1ì¼)

**ëª©í‘œ**: ê³µì§€ì‚¬í•­ ë¶„ë¦¬ ë° ë²„ì „ ê´€ë¦¬

#### 3-1. Supabase ì‘ì—… (30ë¶„)

```sql
-- 1. notice_policy í…Œì´ë¸” ìƒì„±
CREATE TABLE public.notice_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- ê³µì§€ ë‚´ìš©
    title TEXT,
    content TEXT NOT NULL,
    
    -- ë²„ì „ ê´€ë¦¬ (í•µì‹¬!)
    notice_version INTEGER NOT NULL DEFAULT 1,
    
    -- ë¶€ê°€ ì •ë³´
    image_url TEXT,
    action_url TEXT,
    
    CONSTRAINT notice_policy_pkey PRIMARY KEY (id),
    CONSTRAINT notice_policy_unique_active 
        UNIQUE (app_id, is_active) 
        WHERE is_active = true
);

-- 2. ì¸ë±ìŠ¤
CREATE INDEX idx_notice_policy_app_id ON public.notice_policy(app_id);
CREATE INDEX idx_notice_policy_active ON public.notice_policy(is_active);

-- 3. RLS ì •ì±…
ALTER TABLE public.notice_policy ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allow_read_notice_policy"
ON public.notice_policy
FOR SELECT
USING (true);

-- 4. ì½”ë©˜íŠ¸
COMMENT ON TABLE public.notice_policy IS 'ì¼ë°˜ ê³µì§€ì‚¬í•­ íŒì—… ì •ì±… (ì´ë²¤íŠ¸, ì‹ ê·œ ê¸°ëŠ¥ ì•ˆë‚´ ë“±)';
COMMENT ON COLUMN public.notice_policy.notice_version IS 'ê³µì§€ ë²„ì „ (ì¦ê°€ ì‹œ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì¬í‘œì‹œ)';
```

#### 3-2. Kotlin ëª¨ë¸ ìƒì„± (20ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/model/NoticePolicy.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class NoticePolicy(
    @SerialName("id")
    val id: Long? = null,

    @SerialName("created_at")
    val createdAt: String? = null,

    @SerialName("app_id")
    val appId: String,

    @SerialName("is_active")
    val isActive: Boolean = false,

    @SerialName("title")
    val title: String? = null,

    @SerialName("content")
    val content: String,

    // ë²„ì „ ê´€ë¦¬ (í•µì‹¬!)
    @SerialName("notice_version")
    val noticeVersion: Int = 1,

    @SerialName("image_url")
    val imageUrl: String? = null,

    @SerialName("action_url")
    val actionUrl: String? = null
)
```

#### 3-3. Repository ìƒì„± (20ë¶„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/data/supabase/repository/NoticePolicyRepository.kt`

```kotlin
package com.sweetapps.pocketchord.data.supabase.repository

import com.sweetapps.pocketchord.data.supabase.model.NoticePolicy
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from

class NoticePolicyRepository(
    private val client: SupabaseClient,
    private val appId: String = com.sweetapps.pocketchord.BuildConfig.SUPABASE_APP_ID
) {
    /**
     * í™œì„± ê³µì§€ ì •ì±… ì¡°íšŒ
     */
    suspend fun getActiveNotice(): Result<NoticePolicy?> = runCatching {
        client.from("notice_policy")
            .select()
            .decodeList<NoticePolicy>()
            .find { it.appId == appId && it.isActive }
    }
}
```

#### 3-4. ë²„ì „ ê¸°ë°˜ ì¶”ì  ë¡œì§ êµ¬í˜„ (1-2ì‹œê°„)

**íŒŒì¼**: `app/src/main/java/com/sweetapps/pocketchord/ui/screens/HomeScreen.kt`

```kotlin
val noticeRepo = remember { NoticePolicyRepository(supabaseClient) }

LaunchedEffect(Unit) {
    // 1. Emergency í™•ì¸
    // ...
    
    // 2. Update í™•ì¸
    // ...
    
    // 3. Notice í™•ì¸ (ë²„ì „ ê¸°ë°˜!)
    noticeRepo.getActiveNotice()
        .onSuccess { notice ->
            notice?.let { n ->
                // ë²„ì „ ê¸°ë°˜ ì¶”ì 
                val prefs = context.getSharedPreferences("notice_prefs", Context.MODE_PRIVATE)
                val viewedVersions = prefs.getStringSet("viewed_notices", setOf()) ?: setOf()
                val identifier = "notice_v${n.noticeVersion}"
                
                if (viewedVersions.contains(identifier)) {
                    Log.d("HomeScreen", "Already viewed notice version ${n.noticeVersion}")
                } else {
                    Log.d("HomeScreen", "Showing new notice version ${n.noticeVersion}")
                    announcement = Announcement(
                        id = n.id,
                        title = n.title ?: "ê³µì§€ì‚¬í•­",
                        content = n.content,
                        isActive = true,
                        kind = "announcement"
                    )
                    showAnnouncementDialog = true
                }
            }
        }
        .onFailure { e ->
            Log.e("HomeScreen", "Failed to load notice policy", e)
        }
}

// AnnouncementDialog ìˆ˜ì • (ë²„ì „ ì €ì¥)
AnnouncementDialog(
    announcement = announcement!!,
    onDismiss = {
        noticeRepo.getActiveNotice().getOrNull()?.let { notice ->
            val prefs = context.getSharedPreferences("notice_prefs", Context.MODE_PRIVATE)
            val viewedVersions = prefs.getStringSet("viewed_notices", setOf())
                ?.toMutableSet() ?: mutableSetOf()
            
            val identifier = "notice_v${notice.noticeVersion}"
            viewedVersions.add(identifier)
            
            prefs.edit {
                putStringSet("viewed_notices", viewedVersions)
            }
            
            Log.d("HomeScreen", "Marked notice version ${notice.noticeVersion} as viewed")
        }
        showAnnouncementDialog = false
    }
)
```

#### 3-5. í…ŒìŠ¤íŠ¸ (1ì‹œê°„)

- [ ] notice íŒì—… í‘œì‹œ í™•ì¸
- [ ] X í´ë¦­ í›„ ì¬ì‹¤í–‰ ì‹œ í‘œì‹œ ì•ˆ ë¨ í™•ì¸
- [ ] Supabaseì—ì„œ notice_version ì¦ê°€ í›„ ì¬í‘œì‹œ í™•ì¸
- [ ] Supabaseì—ì„œ contentë§Œ ë³€ê²½ (ë²„ì „ ìœ ì§€) í›„ ì¬í‘œì‹œ ì•ˆ ë¨ í™•ì¸
- [ ] ìš°ì„ ìˆœìœ„ í™•ì¸ (emergency > update > notice)

---

### ğŸ”´ Phase 4: app_policy ì •ë¦¬ (0.5ì¼)

**ëª©í‘œ**: ê¸°ì¡´ app_policy ì •ë¦¬ (ì„ íƒì‚¬í•­)

#### ì˜µì…˜ A: app_policyë¥¼ ad_policyë¡œ ì´ë¦„ ë³€ê²½ (ê¶Œì¥)

```sql
-- 1. ìƒˆ í…Œì´ë¸” ìƒì„± (ê´‘ê³  ì •ì±…ë§Œ)
CREATE TABLE public.ad_policy AS
SELECT 
    id,
    created_at,
    app_id,
    is_active,
    ad_app_open_enabled,
    ad_interstitial_enabled,
    ad_banner_enabled,
    ad_interstitial_max_per_hour,
    ad_interstitial_max_per_day
FROM app_policy;

-- 2. ì œì•½ì¡°ê±´ ì¶”ê°€
ALTER TABLE ad_policy
ADD CONSTRAINT ad_policy_pkey PRIMARY KEY (id),
ADD CONSTRAINT ad_policy_unique_active 
    UNIQUE (app_id, is_active) 
    WHERE is_active = true;

-- 3. ì¸ë±ìŠ¤
CREATE INDEX idx_ad_policy_app_id ON ad_policy(app_id);

-- 4. RLS
ALTER TABLE ad_policy ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_read_ad_policy" ON ad_policy FOR SELECT USING (true);

-- 5. ê¸°ì¡´ í…Œì´ë¸” ë°±ì—… í›„ ì‚­ì œ (ë‚˜ì¤‘ì—)
-- ALTER TABLE app_policy RENAME TO app_policy_backup;
```

#### ì˜µì…˜ B: app_policy ìœ ì§€ (ê°„ë‹¨)

```sql
-- ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì œê±°
ALTER TABLE app_policy
DROP COLUMN IF EXISTS active_popup_type,
DROP COLUMN IF EXISTS min_supported_version,
DROP COLUMN IF EXISTS latest_version_code,
DROP COLUMN IF EXISTS content,
DROP COLUMN IF EXISTS download_url;
```

---

### ğŸŸ£ Phase 5: ë¬¸ì„œí™” ë° ìš´ì˜ ê°€ì´ë“œ (0.5ì¼)

#### 5-1. ìš´ì˜ ê°€ì´ë“œ ì‘ì„±

**íŒŒì¼**: `docs/POLICY-OPERATION-GUIDE.md`

```markdown
# ì •ì±… ìš´ì˜ ê°€ì´ë“œ

## ì—…ë°ì´íŠ¸ ì •ì±… (update_policy)

### ê°•ì œ ì—…ë°ì´íŠ¸ ì„¤ì •
UPDATE update_policy 
SET target_version_code = 12,
    is_force_update = true,
    message = 'í•„ìˆ˜ ì—…ë°ì´íŠ¸ì…ë‹ˆë‹¤'
WHERE app_id = 'com.sweetapps.pocketchord';

### ì„ íƒì  ì—…ë°ì´íŠ¸ ì„¤ì •
UPDATE update_policy 
SET target_version_code = 15,
    is_force_update = false,
    message = 'ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤'
WHERE app_id = 'com.sweetapps.pocketchord';

## ê³µì§€ì‚¬í•­ ì •ì±… (notice_policy)

### ìƒˆ ê³µì§€ (ë²„ì „ ì¦ê°€!)
UPDATE notice_policy 
SET content = '2ì›” ì´ë²¤íŠ¸',
    notice_version = notice_version + 1
WHERE app_id = 'com.sweetapps.pocketchord';

### ì˜¤íƒ€ ìˆ˜ì • (ë²„ì „ ìœ ì§€!)
UPDATE notice_policy 
SET content = 'ìˆ˜ì •ëœ ë‚´ìš©'
WHERE app_id = 'com.sweetapps.pocketchord';
-- notice_versionì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ!

## ê¸´ê¸‰ ì •ì±… (emergency_policy)

### ê¸´ê¸‰ ìƒí™© í™œì„±í™”
INSERT INTO emergency_policy (app_id, content, redirect_url, is_dismissible)
VALUES (
    'com.sweetapps.pocketchord',
    'âš ï¸ ì´ ì•±ì€ ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
    'https://play.google.com/store/apps/details?id=com.sweetapps.new',
    true  -- Google Play ì •ì±… ì¤€ìˆ˜ (X ë²„íŠ¼ í—ˆìš©)
);

### ê¸´ê¸‰ ìƒí™© ì¢…ë£Œ
UPDATE emergency_policy 
SET is_active = false
WHERE app_id = 'com.sweetapps.pocketchord';
```

#### 5-2. API ë¬¸ì„œ ì—…ë°ì´íŠ¸

- [ ] README.md ì—…ë°ì´íŠ¸
- [ ] SUPABASE-TABLE-CREATION-SUCCESS.md ì—…ë°ì´íŠ¸
- [ ] ê° í…Œì´ë¸”ë³„ ìƒì„¸ ë¬¸ì„œ ë§í¬ ì¶”ê°€

---

## âœ… ì „ì²´ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: update_policy (1ì¼)
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] UpdatePolicy ëª¨ë¸ ìƒì„±
- [ ] UpdatePolicyRepository ìƒì„±
- [ ] HomeScreen í†µí•©
- [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### Phase 2: emergency_policy (1ì¼)
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] EmergencyPolicy ëª¨ë¸ ìƒì„±
- [ ] EmergencyPolicyRepository ìƒì„±
- [ ] HomeScreen í†µí•© (ìš°ì„ ìˆœìœ„ 1)
- [ ] EmergencyRedirectDialog ìˆ˜ì •
- [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### Phase 3: notice_policy (1ì¼)
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] NoticePolicy ëª¨ë¸ ìƒì„±
- [ ] NoticePolicyRepository ìƒì„±
- [ ] ë²„ì „ ê¸°ë°˜ ì¶”ì  ë¡œì§ êµ¬í˜„
- [ ] HomeScreen í†µí•© (ìš°ì„ ìˆœìœ„ 3)
- [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### Phase 4: app_policy ì •ë¦¬ (0.5ì¼)
- [ ] ad_policy í…Œì´ë¸” ìƒì„± (ë˜ëŠ” ì»¬ëŸ¼ ì œê±°)
- [ ] ê´‘ê³  ì •ì±… ì½”ë“œ ìˆ˜ì •
- [ ] ê¸°ì¡´ app_policy ë°±ì—…

### Phase 5: ë¬¸ì„œí™” (0.5ì¼)
- [ ] ìš´ì˜ ê°€ì´ë“œ ì‘ì„±
- [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] README ì—…ë°ì´íŠ¸

---

## ğŸ”„ ë¡¤ë°± ê³„íš

### Phase 1 ë¡¤ë°±

```sql
-- update_policy í…Œì´ë¸” ì‚­ì œ
DROP TABLE IF EXISTS update_policy;

-- ì½”ë“œ: AppPolicyRepository ê³„ì† ì‚¬ìš©
```

### Phase 2 ë¡¤ë°±

```sql
-- emergency_policy í…Œì´ë¸” ì‚­ì œ
DROP TABLE IF EXISTS emergency_policy;

-- ì½”ë“œ: app_policyì˜ active_popup_type='emergency' ê³„ì† ì‚¬ìš©
```

### Phase 3 ë¡¤ë°±

```sql
-- notice_policy í…Œì´ë¸” ì‚­ì œ
DROP TABLE IF EXISTS notice_policy;

-- ì½”ë“œ: app_policyì˜ active_popup_type='notice' ê³„ì† ì‚¬ìš©
```

---

## ğŸ“Š ì˜ˆìƒ ì¼ì •

```
Day 1: Phase 1 (update_policy)
  â”œâ”€ ì˜¤ì „: Supabase ì‘ì—… + ëª¨ë¸/Repository ìƒì„±
  â””â”€ ì˜¤í›„: HomeScreen í†µí•© + í…ŒìŠ¤íŠ¸

Day 2: Phase 2 (emergency_policy)
  â”œâ”€ ì˜¤ì „: Supabase ì‘ì—… + ëª¨ë¸/Repository ìƒì„±
  â””â”€ ì˜¤í›„: HomeScreen í†µí•© + í…ŒìŠ¤íŠ¸

Day 3: Phase 3 (notice_policy)
  â”œâ”€ ì˜¤ì „: Supabase ì‘ì—… + ëª¨ë¸/Repository ìƒì„±
  â””â”€ ì˜¤í›„: ë²„ì „ ì¶”ì  ë¡œì§ + í…ŒìŠ¤íŠ¸

Day 4: Phase 4-5 (ì •ë¦¬ + ë¬¸ì„œí™”)
  â”œâ”€ ì˜¤ì „: app_policy ì •ë¦¬
  â””â”€ ì˜¤í›„: ë¬¸ì„œ ì‘ì„±

Day 5: í†µí•© í…ŒìŠ¤íŠ¸ ë° ë°°í¬
  â”œâ”€ ì˜¤ì „: ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
  â””â”€ ì˜¤í›„: ë°°í¬ ì¤€ë¹„
```

---

## ğŸ¯ ì„±ê³µ ê¸°ì¤€

1. âœ… 3ê°œ í…Œì´ë¸” ëª¨ë‘ ì •ìƒ ì‘ë™
2. âœ… ìš°ì„ ìˆœìœ„ ë¡œì§ ì •ìƒ ì‘ë™ (emergency > update > notice)
3. âœ… ì—…ë°ì´íŠ¸: target_version_code ë‹¨ì¼ í•„ë“œë¡œ ì •ìƒ ì‘ë™
4. âœ… ê¸´ê¸‰: is_dismissibleë¡œ X ë²„íŠ¼ ì œì–´ ê°€ëŠ¥
5. âœ… ê³µì§€: notice_versionìœ¼ë¡œ ì¬í‘œì‹œ ì œì–´ ê°€ëŠ¥
6. âœ… 100ê°œ ì•± í™•ì¥ ê°€ëŠ¥ (1ê°œ ì•± = 1ê°œ í–‰ ìœ ì§€)
7. âœ… ê¸°ì¡´ ê¸°ëŠ¥ íšŒê·€ ì—†ìŒ

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- `popup-tracking-analysis.md` - ì „ì²´ ë¶„ì„
- `update-policy-redesign.md` - ì—…ë°ì´íŠ¸ ì •ì±… ì¬ì„¤ê³„
- `notice-policy-redesign.md` - ê³µì§€ì‚¬í•­ ì •ì±… ì¬ì„¤ê³„
- `SUPABASE-ID-COLUMN-GUIDE.md` - Supabase ID ì»¬ëŸ¼ ê°€ì´ë“œ

---

**ì‘ì„±ì¼**: 2025-11-09  
**ìµœì¢… ê²€í† **: 2025-11-09  
**ì˜ˆìƒ ì™„ë£Œì¼**: 2025-11-14 (5ì¼)  
**ë‹´ë‹¹ì**: PocketChord ê°œë°œíŒ€

