# íŒì—… ì •ì±… ë¦¬íŒ©í† ë§ - ë¹ ë¥¸ ì°¸ì¡° ê°€ì´ë“œ

**ì‘ì„±ì¼**: 2025-11-09  
**ì˜ˆìƒ ê¸°ê°„**: 3-5ì¼

---

## ğŸ¯ í•œëˆˆì— ë³´ëŠ” ë³€ê²½ì‚¬í•­

### Before â†’ After

```
âŒ Before: 1ê°œ í…Œì´ë¸” (app_policy)
   - ëª¨ë“  íŒì—…ì„ í•œ ê³³ì— ê´€ë¦¬
   - í•„ë“œëª… í˜¼ë€ (min_supported vs latest_version)
   - ì¶”ì  ë¶ˆê°€ëŠ¥ (notice)
   - Google Play ìœ„ë°˜ ê°€ëŠ¥ (emergency)

âœ… After: 3ê°œ í…Œì´ë¸” ë¶„ë¦¬
   - update_policy: ì—…ë°ì´íŠ¸ ì „ìš©
   - notice_policy: ê³µì§€ ì „ìš©
   - emergency_policy: ê¸´ê¸‰ ì „ìš©
```

---

## ğŸ“‹ 5ë‹¨ê³„ êµ¬í˜„ ê³„íš

### Phase 1: update_policy (1ì¼) â­
- **ëª©í‘œ**: ì—…ë°ì´íŠ¸ ì •ì±… ë¶„ë¦¬ ë° ë‹¨ìˆœí™”
- **í•µì‹¬**: `target_version_code` (ë‹¨ì¼ í•„ë“œ) + `is_force_update`
- **íŒŒì¼**: UpdatePolicy.kt, UpdatePolicyRepository.kt

### Phase 2: emergency_policy (1ì¼) â­
- **ëª©í‘œ**: ê¸´ê¸‰ ìƒí™© ë¶„ë¦¬ ë° Google Play ì¤€ìˆ˜
- **í•µì‹¬**: `is_dismissible` (X ë²„íŠ¼ ì œì–´)
- **íŒŒì¼**: EmergencyPolicy.kt, EmergencyPolicyRepository.kt

### Phase 3: notice_policy (1ì¼) â­
- **ëª©í‘œ**: ê³µì§€ì‚¬í•­ ë¶„ë¦¬ ë° ë²„ì „ ê´€ë¦¬
- **í•µì‹¬**: `notice_version` (ëª…ì‹œì  ì œì–´)
- **íŒŒì¼**: NoticePolicy.kt, NoticePolicyRepository.kt

### Phase 4: app_policy ì •ë¦¬ (0.5ì¼)
- **ëª©í‘œ**: ê¸°ì¡´ í…Œì´ë¸” ì •ë¦¬
- **ì˜µì…˜**: ad_policyë¡œ ì´ë¦„ ë³€ê²½ ë˜ëŠ” ì»¬ëŸ¼ ì œê±°

### Phase 5: ë¬¸ì„œí™” (0.5ì¼)
- **ëª©í‘œ**: ìš´ì˜ ê°€ì´ë“œ ì‘ì„±
- **íŒŒì¼**: POLICY-OPERATION-GUIDE.md

---

## ğŸ”‘ í•µì‹¬ ë³€ê²½ì‚¬í•­

### 1. update_policy (ë‹¨ìˆœí™”!)

```sql
-- Before (í˜¼ë€ìŠ¤ëŸ¬ì›€)
min_supported_version: 10 | NULL
latest_version_code: NULL | 15
active_popup_type: 'force_update' | 'optional_update'

-- After (ëª…í™•í•¨)
target_version_code: 12
is_force_update: true | false
```

### 2. emergency_policy (Google Play ì¤€ìˆ˜!)

```sql
-- Before (X ë²„íŠ¼ í•˜ë“œì½”ë”©)
isDismissible = false  (ì½”ë“œì—ì„œ ê³ ì •)

-- After (DBì—ì„œ ì œì–´)
is_dismissible: true | false  (ìœ ì—°í•˜ê²Œ ê´€ë¦¬)
```

### 3. notice_policy (ë²„ì „ ê´€ë¦¬!)

```kotlin
// Before (id ê¸°ë°˜, ì¬í‘œì‹œ ì•ˆ ë¨)
val identifier = policy.id.toString()

// After (ë²„ì „ ê¸°ë°˜, ëª…ì‹œì  ì œì–´)
val identifier = "notice_v${policy.noticeVersion}"
```

---

## ğŸ“Š ìš°ì„ ìˆœìœ„ ë¡œì§

```kotlin
LaunchedEffect(Unit) {
    // 1ìˆœìœ„: Emergency
    val emergency = emergencyRepo.getActiveEmergency()
    if (emergency != null) {
        showEmergencyDialog = true
        return  // ê¸´ê¸‰ì´ë©´ ë‹¤ë¥¸ íŒì—… ë¬´ì‹œ
    }
    
    // 2ìˆœìœ„: Update (ê°•ì œ > ì„ íƒ)
    val update = updateRepo.getPolicy()
    if (update?.requiresForceUpdate(currentVersion) == true) {
        showForceUpdateDialog = true
        return
    }
    if (update?.recommendsOptionalUpdate(currentVersion) == true) {
        showOptionalUpdateDialog = true
        return
    }
    
    // 3ìˆœìœ„: Notice
    val notice = noticeRepo.getActiveNotice()
    if (notice != null && !isViewed(notice.noticeVersion)) {
        showNoticeDialog = true
    }
}
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### Day 1: update_policy
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] UpdatePolicy.kt ìƒì„±
- [ ] UpdatePolicyRepository.kt ìƒì„±
- [ ] HomeScreen í†µí•©
- [ ] í…ŒìŠ¤íŠ¸

### Day 2: emergency_policy
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] EmergencyPolicy.kt ìƒì„±
- [ ] EmergencyPolicyRepository.kt ìƒì„±
- [ ] HomeScreen í†µí•© (ìš°ì„ ìˆœìœ„ 1)
- [ ] í…ŒìŠ¤íŠ¸

### Day 3: notice_policy
- [ ] Supabase í…Œì´ë¸” ìƒì„±
- [ ] NoticePolicy.kt ìƒì„±
- [ ] NoticePolicyRepository.kt ìƒì„±
- [ ] ë²„ì „ ì¶”ì  ë¡œì§ êµ¬í˜„
- [ ] HomeScreen í†µí•© (ìš°ì„ ìˆœìœ„ 3)
- [ ] í…ŒìŠ¤íŠ¸

### Day 4-5: ì •ë¦¬ + ë¬¸ì„œí™”
- [ ] app_policy ì •ë¦¬
- [ ] ìš´ì˜ ê°€ì´ë“œ ì‘ì„±
- [ ] í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ë°°í¬ ì¤€ë¹„

---

## ğŸ¯ ì„±ê³µ ê¸°ì¤€

1. âœ… 3ê°œ í…Œì´ë¸” ì •ìƒ ì‘ë™
2. âœ… ìš°ì„ ìˆœìœ„ ë¡œì§ ì •ìƒ ì‘ë™
3. âœ… ì—…ë°ì´íŠ¸: ë‹¨ì¼ í•„ë“œë¡œ ë‹¨ìˆœí™”
4. âœ… ê¸´ê¸‰: X ë²„íŠ¼ ì œì–´ ê°€ëŠ¥
5. âœ… ê³µì§€: ë²„ì „ ê´€ë¦¬ ê°€ëŠ¥
6. âœ… 100ê°œ ì•± í™•ì¥ ê°€ëŠ¥
7. âœ… íšŒê·€ ì—†ìŒ

---

## ğŸ”§ Supabase SQL ìŠ¤í¬ë¦½íŠ¸ (ë³µì‚¬í•´ì„œ ì‚¬ìš©)

### update_policy í…Œì´ë¸”

```sql
CREATE TABLE public.update_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    target_version_code INT NOT NULL,
    is_force_update BOOLEAN NOT NULL,
    message TEXT,
    release_notes TEXT,
    download_url TEXT,
    CONSTRAINT update_policy_pkey PRIMARY KEY (id),
    CONSTRAINT update_policy_unique_active UNIQUE (app_id, is_active) WHERE is_active = true
);
CREATE INDEX idx_update_policy_app_id ON public.update_policy(app_id);
CREATE INDEX idx_update_policy_active ON public.update_policy(is_active);
ALTER TABLE public.update_policy ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_read_update_policy" ON public.update_policy FOR SELECT USING (true);
```

### emergency_policy í…Œì´ë¸”

```sql
CREATE TABLE public.emergency_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    content TEXT NOT NULL,
    redirect_url TEXT,
    new_app_id TEXT,
    is_dismissible BOOLEAN NOT NULL DEFAULT TRUE,
    CONSTRAINT emergency_policy_pkey PRIMARY KEY (id),
    CONSTRAINT emergency_policy_unique_active UNIQUE (app_id, is_active) WHERE is_active = true
);
CREATE INDEX idx_emergency_policy_app_id ON public.emergency_policy(app_id);
CREATE INDEX idx_emergency_policy_active ON public.emergency_policy(is_active);
ALTER TABLE public.emergency_policy ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_read_emergency_policy" ON public.emergency_policy FOR SELECT USING (true);
```

### notice_policy í…Œì´ë¸”

```sql
CREATE TABLE public.notice_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    title TEXT,
    content TEXT NOT NULL,
    notice_version INTEGER NOT NULL DEFAULT 1,
    image_url TEXT,
    action_url TEXT,
    CONSTRAINT notice_policy_pkey PRIMARY KEY (id),
    CONSTRAINT notice_policy_unique_active UNIQUE (app_id, is_active) WHERE is_active = true
);
CREATE INDEX idx_notice_policy_app_id ON public.notice_policy(app_id);
CREATE INDEX idx_notice_policy_active ON public.notice_policy(is_active);
ALTER TABLE public.notice_policy ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_read_notice_policy" ON public.notice_policy FOR SELECT USING (true);
```

---

## ğŸ“š ìƒì„¸ ë¬¸ì„œ

- **ì „ì²´ ê³„íš**: `IMPLEMENTATION-PLAN.md`
- **ì—…ë°ì´íŠ¸ ì¬ì„¤ê³„**: `update-policy-redesign.md`
- **ê³µì§€ì‚¬í•­ ì¬ì„¤ê³„**: `notice-policy-redesign.md`
- **ì „ì²´ ë¶„ì„**: `popup-tracking-analysis.md`

---

**ì‹œì‘ ì¤€ë¹„ ì™„ë£Œ!** ğŸš€  
Phase 1ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì„¸ìš”!

