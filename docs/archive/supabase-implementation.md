# PocketChord Supabase êµ¬í˜„ ê°€ì´ë“œ

> ì‹¤ì œ ì½”ë“œ êµ¬í˜„, ì‚¬ìš©ë²•, ì£¼ìš” ì„¤ì •ì„ ë‹´ì€ ì‹¤ìš© ê°€ì´ë“œ

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-05

---

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
app/src/main/java/com/sweetapps/pocketchord/data/supabase/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ Announcement.kt          (ê³µì§€ì‚¬í•­ ëª¨ë¸)
â”‚   â””â”€â”€ UpdateInfo.kt            (ì•± ë²„ì „ ì •ë³´ ëª¨ë¸)
â””â”€â”€ repository/
    â”œâ”€â”€ AnnouncementRepository.kt
    â””â”€â”€ UpdateInfoRepository.kt
```

**êµ¬ì¡° ì›ì¹™:**
- `model/` - ë°ì´í„° êµ¬ì¡° ì •ì˜
- `repository/` - ë°ì´í„° ì ‘ê·¼ ë¡œì§
- Clean Architecture ì¤€ìˆ˜

---

## ğŸ”‘ í•µì‹¬ ì„¤ì •

### 1. Supabase í…Œì´ë¸” êµ¬ì¡°

#### announcements í…Œì´ë¸”
```sql
CREATE TABLE public.announcements (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    app_id TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    CONSTRAINT announcements_pkey PRIMARY KEY (id)
);

CREATE INDEX idx_announcements_active ON announcements(is_active);
CREATE INDEX idx_announcements_app_id ON announcements(app_id, is_active);

ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can read active announcements"
ON announcements FOR SELECT
USING (is_active = true);
```

### 2. app_id ì„¤ì • â­ ì¤‘ìš”

**ì•± íŒ¨í‚¤ì§€ëª… ì‚¬ìš©**: `com.sweetapps.pocketchord`

```kotlin
// ëª¨ë¸ ê¸°ë³¸ê°’
@SerialName("app_id")
val appId: String = "com.sweetapps.pocketchord"

// Repository ê¸°ë³¸ê°’
private val appId: String = "com.sweetapps.pocketchord"
```

**Supabase ë°ì´í„° ì…ë ¥ ì‹œ:**
```sql
INSERT INTO announcements (app_id, title, content, is_active)
VALUES ('com.sweetapps.pocketchord', 'í™˜ì˜í•©ë‹ˆë‹¤!', 'ë‚´ìš©...', true);
```

---

## ğŸ“¦ ëª¨ë¸ ì •ì˜

### Announcement.kt
```kotlin
package com.sweetapps.pocketchord.data.supabase.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class Announcement(
    @SerialName("id")
    val id: Long? = null,

    @SerialName("created_at")
    val createdAt: String? = null,

    @SerialName("app_id")
    val appId: String = "com.sweetapps.pocketchord",

    @SerialName("title")
    val title: String,

    @SerialName("content")
    val content: String,

    @SerialName("is_active")
    val isActive: Boolean = true
)
```

### UpdateInfo.kt (AppVersion)
```kotlin
package com.sweetapps.pocketchord.data.supabase.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class AppVersion(
    @SerialName("id")
    val id: Long? = null,

    @SerialName("version_code")
    val versionCode: Int,

    @SerialName("version_name")
    val versionName: String,

    @SerialName("min_required_version")
    val minRequiredVersion: Int,

    @SerialName("release_notes")
    val releaseNotes: String,

    @SerialName("is_force_update")
    val isForceUpdate: Boolean = false,

    @SerialName("download_url")
    val downloadUrl: String? = null,

    @SerialName("released_at")
    val releasedAt: String? = null
)
```

---

## ğŸ”„ Repository êµ¬í˜„

### AnnouncementRepository.kt
```kotlin
package com.sweetapps.pocketchord.data.supabase.repository

import com.sweetapps.pocketchord.data.supabase.model.Announcement
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from

class AnnouncementRepository(
    private val client: SupabaseClient,
    private val appId: String = "com.sweetapps.pocketchord"
) {
    /**
     * ëª¨ë“  í™œì„± ê³µì§€ì‚¬í•­ ì¡°íšŒ
     */
    suspend fun getAnnouncements(): Result<List<Announcement>> = runCatching {
        client.from("announcements")
            .select()
            .decodeList<Announcement>()
            .filter { it.appId == appId && it.isActive }
            .sortedByDescending { it.createdAt }
    }

    /**
     * ìµœì‹  ê³µì§€ì‚¬í•­ 1ê°œ ì¡°íšŒ
     */
    suspend fun getLatestAnnouncement(): Result<Announcement?> = runCatching {
        client.from("announcements")
            .select()
            .decodeList<Announcement>()
            .filter { it.appId == appId && it.isActive }
            .maxByOrNull { it.createdAt ?: "" }
    }

    /**
     * ìµœê·¼ Nê°œ ê³µì§€ì‚¬í•­ ì¡°íšŒ
     */
    suspend fun getRecentAnnouncements(limit: Int = 5): Result<List<Announcement>> = runCatching {
        client.from("announcements")
            .select()
            .decodeList<Announcement>()
            .filter { it.appId == appId && it.isActive }
            .sortedByDescending { it.createdAt }
            .take(limit)
    }
}
```

### UpdateInfoRepository.kt
```kotlin
package com.sweetapps.pocketchord.data.supabase.repository

import com.sweetapps.pocketchord.data.supabase.model.AppVersion
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from

class UpdateInfoRepository(
    private val client: SupabaseClient
) {
    /**
     * ìµœì‹  ë²„ì „ ì •ë³´ ì¡°íšŒ
     */
    suspend fun getLatestVersion(): Result<AppVersion?> = runCatching {
        client.from("app_versions")
            .select()
            .decodeList<AppVersion>()
            .maxByOrNull { it.versionCode }
    }

    /**
     * ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ í™•ì¸
     */
    suspend fun checkUpdateRequired(currentVersionCode: Int): Result<AppVersion?> = runCatching {
        val latest = client.from("app_versions")
            .select()
            .decodeList<AppVersion>()
            .maxByOrNull { it.versionCode }

        if (latest != null && latest.versionCode > currentVersionCode) {
            latest
        } else {
            null
        }
    }

    /**
     * ê°•ì œ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ í™•ì¸
     */
    suspend fun isForceUpdateRequired(currentVersionCode: Int): Result<Boolean> = runCatching {
        val latest = client.from("app_versions")
            .select()
            .decodeList<AppVersion>()
            .maxByOrNull { it.versionCode }

        latest != null &&
                latest.versionCode > currentVersionCode &&
                latest.isForceUpdate
    }
}
```

---

## ğŸ§ª Supabase ì—°ê²° í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ëª©ì 
ì•± ì‹œì‘ ì‹œ Supabaseì—ì„œ ë°ì´í„°ë¥¼ ì œëŒ€ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì½”ë“œ (ì´ë¯¸ ì ìš©ë¨)

`MainActivity.kt`ì— ë‹¤ìŒ ì½”ë“œê°€ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

```kotlin
class MainActivity : ComponentActivity() {
    /**
     * Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
     * 
     * âš ï¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì´ í•¨ìˆ˜ì™€ onCreateì˜ í˜¸ì¶œ ë¶€ë¶„ì„ ì‚­ì œí•˜ì„¸ìš”!
     */
    private fun testSupabaseConnection() {
        lifecycleScope.launch {
            try {
                val repository = AnnouncementRepository(
                    supabase,
                    "com.sweetapps.pocketchord"
                )
                
                val result = repository.getLatestAnnouncement()
                
                result.onSuccess { announcement ->
                    Log.d("SupabaseTest", "announcement: $announcement")
                    announcement?.let {
                        Log.d("SupabaseTest", "id: ${it.id}")
                        Log.d("SupabaseTest", "title: ${it.title}")
                        Log.d("SupabaseTest", "content: ${it.content}")
                        Log.d("SupabaseTest", "isActive: ${it.isActive}")
                        Log.d("SupabaseTest", "createdAt: ${it.createdAt}")
                        Log.d("SupabaseTest", "âœ… Supabase ì—°ê²° ì„±ê³µ!")
                    }
                }.onFailure { error ->
                    Log.e("SupabaseTest", "âŒ Supabase ì—°ê²° ì‹¤íŒ¨", error)
                }
            } catch (e: Exception) {
                Log.e("SupabaseTest", "âŒ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜ˆì™¸ ë°œìƒ", e)
            }
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        setupSplashScreen()
        super.onCreate(savedInstanceState)
        
        // ==================== Supabase í…ŒìŠ¤íŠ¸ ====================
        testSupabaseConnection()
        // ========================================================
        
        enableEdgeToEdge()
        // ...
    }
}
```

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

1. **Supabaseì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€**
   ```sql
   INSERT INTO announcements (app_id, title, content, is_active)
   VALUES ('com.sweetapps.pocketchord', 'í…ŒìŠ¤íŠ¸ ê³µì§€', 'ì—°ê²° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.', true);
   ```

2. **ì•± ì‹¤í–‰**
   - Android Studioì—ì„œ ì•± ì‹¤í–‰
   - ë˜ëŠ” `.\gradlew installDebug`

3. **Logcatì—ì„œ í™•ì¸**
   - Android Studio â†’ Logcat
   - í•„í„°: `SupabaseTest`
   
   **ì„±ê³µ ì‹œ ì¶œë ¥:**
   ```
   D/SupabaseTest: announcement: Announcement(id=1, ...)
   D/SupabaseTest: id: 1
   D/SupabaseTest: title: í…ŒìŠ¤íŠ¸ ê³µì§€
   D/SupabaseTest: content: ì—°ê²° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.
   D/SupabaseTest: isActive: true
   D/SupabaseTest: createdAt: 2025-11-05T...
   D/SupabaseTest: appId: com.sweetapps.pocketchord
   D/SupabaseTest: âœ… Supabase ì—°ê²° ì„±ê³µ!
   ```
   
   **ë°ì´í„° ì—†ì„ ì‹œ:**
   ```
   W/SupabaseTest: âš ï¸ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. Supabaseì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
   ```
   
   **ì‹¤íŒ¨ ì‹œ:**
   ```
   E/SupabaseTest: âŒ Supabase ì—°ê²° ì‹¤íŒ¨
   E/SupabaseTest: Error: [ì—ëŸ¬ ë©”ì‹œì§€]
   ```

### âš ï¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì œê±° (ì¤‘ìš”!)

í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ **ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì œê±°**í•˜ì„¸ìš”!

#### ì œê±°í•  ì½”ë“œ

**1. testSupabaseConnection() í•¨ìˆ˜ ì „ì²´ ì‚­ì œ**
```kotlin
// ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ì‚­ì œ
private fun testSupabaseConnection() {
    lifecycleScope.launch {
        // ...
    }
}
```

**2. onCreateì—ì„œ í˜¸ì¶œ ë¶€ë¶„ ì‚­ì œ**
```kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    setupSplashScreen()
    super.onCreate(savedInstanceState)
    
    // ==================== ì´ ë¶€ë¶„ ì‚­ì œ ====================
    testSupabaseConnection()
    // ====================================================
    
    enableEdgeToEdge()
    // ...
}
```

#### ì œê±° ì´ìœ 
- ì•± ì‹œì‘ë§ˆë‹¤ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë°œìƒ
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” í•„ìš” ì—†ëŠ” ë¡œê·¸
- ì„±ëŠ¥ ì €í•˜

### ëŒ€ì•ˆ: ì¡°ê±´ë¶€ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë‚¨ê²¨ë‘ë˜ ë””ë²„ê·¸ ë¹Œë“œì—ì„œë§Œ ì‹¤í–‰:

```kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    setupSplashScreen()
    super.onCreate(savedInstanceState)
    
    // ë””ë²„ê·¸ ë¹Œë“œì—ì„œë§Œ í…ŒìŠ¤íŠ¸
    if (BuildConfig.DEBUG) {
        testSupabaseConnection()
    }
    
    enableEdgeToEdge()
    // ...
}
```

---

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

`MainActivity.kt`:
```kotlin
import io.github.jan.supabase.createSupabaseClient
import io.github.jan.supabase.postgrest.Postgrest

val supabase = createSupabaseClient(
    supabaseUrl = "https://your-project.supabase.co",
    supabaseKey = "your-anon-key"
) {
    install(Postgrest)
}
```

### 2. Repository ìƒì„± ë° ì‚¬ìš©

```kotlin
import androidx.lifecycle.lifecycleScope
import kotlinx.coroutines.launch

class MainActivity : ComponentActivity() {
    private val announcementRepo = AnnouncementRepository(supabase)
    private val updateRepo = UpdateInfoRepository(supabase)
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        lifecycleScope.launch {
            // ê³µì§€ì‚¬í•­ ì¡°íšŒ
            announcementRepo.getLatestAnnouncement()
                .onSuccess { announcement ->
                    announcement?.let {
                        showAnnouncementDialog(it.title, it.content)
                    }
                }
                .onFailure { error ->
                    Log.e("Supabase", "ì¡°íšŒ ì‹¤íŒ¨", error)
                }
            
            // ì—…ë°ì´íŠ¸ í™•ì¸
            updateRepo.checkUpdateRequired(BuildConfig.VERSION_CODE)
                .onSuccess { newVersion ->
                    if (newVersion != null) {
                        showUpdateDialog(newVersion)
                    }
                }
        }
    }
}
```

### 3. Composeì—ì„œ ì‚¬ìš©

```kotlin
@Composable
fun AnnouncementsScreen() {
    var announcements by remember { mutableStateOf<List<Announcement>>(emptyList()) }
    var isLoading by remember { mutableStateOf(true) }
    var error by remember { mutableStateOf<String?>(null) }
    
    val repository = remember { AnnouncementRepository(supabase) }
    
    LaunchedEffect(Unit) {
        repository.getAnnouncements()
            .onSuccess { 
                announcements = it
                isLoading = false
            }
            .onFailure { 
                error = it.message
                isLoading = false
            }
    }
    
    when {
        isLoading -> CircularProgressIndicator()
        error != null -> Text("ì˜¤ë¥˜: $error", color = Color.Red)
        announcements.isEmpty() -> Text("ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤")
        else -> LazyColumn {
            items(announcements) { announcement ->
                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(16.dp)
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(announcement.title, style = MaterialTheme.typography.titleLarge)
                        Spacer(Modifier.height(8.dp))
                        Text(announcement.content, style = MaterialTheme.typography.bodyMedium)
                    }
                }
            }
        }
    }
}
```

---

## ğŸ“‹ Supabase ê´€ë¦¬

### ê³µì§€ì‚¬í•­ ì¶”ê°€
```sql
INSERT INTO announcements (app_id, title, content, is_active)
VALUES ('com.sweetapps.pocketchord', 'ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸!', 'ë²„ì „ 2.0ì´ ì¶œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
```

### ê³µì§€ì‚¬í•­ ë¹„í™œì„±í™”
```sql
UPDATE announcements 
SET is_active = false 
WHERE id = 1;
```

### ë²„ì „ ì •ë³´ ì¶”ê°€ (ì„ íƒì‚¬í•­)
```sql
INSERT INTO app_versions (version_code, version_name, min_required_version, release_notes)
VALUES (2, '2.0.0', 1, '- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€\n- ë²„ê·¸ ìˆ˜ì •');
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. app_id ì¼ê´€ì„±
- âœ… í•­ìƒ `"com.sweetapps.pocketchord"` ì‚¬ìš©
- âŒ `"pocketchord"` ê°™ì€ ì§§ì€ ì´ë¦„ ì‚¬ìš© ê¸ˆì§€

### 2. ë„¤íŠ¸ì›Œí¬ ê¶Œí•œ
`AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

### 3. ì˜ì¡´ì„± í™•ì¸
`libs.versions.toml`:
```toml
[versions]
kotlin = "2.2.21"
supabase = "3.2.6"
ktor = "3.3.1"

[libraries]
supabase-bom = { group = "io.github.jan-tennert.supabase", name = "bom", version.ref = "supabase" }
supabase-postgrest = { group = "io.github.jan-tennert.supabase", name = "postgrest-kt", version.ref = "supabase" }
ktor-client-android = { group = "io.ktor", name = "ktor-client-android", version.ref = "ktor" }
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë°ì´í„°ê°€ ì¡°íšŒë˜ì§€ ì•ŠìŒ
1. `app_id` ê°’ í™•ì¸: `"com.sweetapps.pocketchord"` ë§ëŠ”ì§€
2. `is_active` ê°’ í™•ì¸: `true`ì¸ì§€
3. Supabaseì— ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸

### Unresolved reference 'eq' ì—ëŸ¬
- Supabase Kotlin SDKëŠ” ì§ì ‘ `.eq()` ì²´ì´ë‹ ë¶ˆê°€
- ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ `.filter {}`ë¡œ í•„í„°ë§

### ì»´íŒŒì¼ ì—ëŸ¬
```bash
.\gradlew clean
.\gradlew build
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### Supabase ì„¤ì •
- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„±
- [ ] announcements í…Œì´ë¸” ìƒì„±
- [ ] RLS ì •ì±… ì„¤ì •
- [ ] í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
- [ ] API í‚¤ í™•ì¸

### Android í”„ë¡œì íŠ¸
- [ ] ì˜ì¡´ì„± ì¶”ê°€
- [ ] INTERNET ê¶Œí•œ ì¶”ê°€
- [ ] ëª¨ë¸ íŒŒì¼ ìƒì„± (model/)
- [ ] Repository íŒŒì¼ ìƒì„± (repository/)
- [ ] Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

### í…ŒìŠ¤íŠ¸
- [ ] ë°ì´í„° ì¡°íšŒ í™•ì¸
- [ ] app_id í•„í„°ë§ í™•ì¸
- [ ] UIì— í‘œì‹œ í™•ì¸

---

**ì™„ë£Œ!** ì´ì œ Supabaseë¥¼ í™œìš©í•œ ê³µì§€ì‚¬í•­ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ‰

