# PocketChord 데이터 업데이트 체계 검토 보고서

## 📅 검토일: 2025-01-01
## 🎯 검토 범위: 코드 시드 데이터 업데이트 메커니즘 전반

---

## ✅ 현재 구현 상태

### 1. 자동 업데이트 메커니즘
- **트리거**: 앱 `versionCode` 변경 감지
- **실행 시점**: `MainActivity.onCreate()` - `launchWhenCreated`
- **전략**: 전체 DB 삭제 후 재시딩
- **즐겨찾기 보존**: Natural key (name + root) 기반

### 2. 데이터 저장 위치
- **파일**: `app/src/main/assets/chords_seed_by_root.json`
- **APK 포함**: 번들 방식 (별도 서버 없음)
- **접근 방식**: AssetManager로 읽기 전용

### 3. DB 스키마
- **Room Database**: `pocket_chord.db` (version 4)
- **테이블**: `chords`, `variants`
- **마이그레이션**: 명시적 경로 정의 (1→2→3→4)

---

## ⚠️ 발견된 문제점

### 1. 🔴 치명적: versionCode 고정 문제
**문제**: `build.gradle.kts`의 `versionCode = 1`로 고정
**영향**: 실제 업데이트 시 자동 리시딩이 작동하지 않음
**해결**: 업데이트 시마다 수동으로 증가시켜야 함 (주석 추가 완료)

### 2. 🟡 중간: 메타데이터 검증 부재
**문제**: JSON 파일 버전/무결성 검증 없음
**영향**: 손상된 데이터로 업데이트 시 감지 불가
**해결**: `_metadata` 필드 추가 및 검증 로직 구현 (완료)

### 3. 🟡 중간: 에러 복구 전략 부재
**문제**: 리시딩 실패 시 DB가 빈 상태로 남을 수 있음
**영향**: 앱이 빈 화면으로 표시될 수 있음
**권장**: 리시딩 실패 시 이전 데이터 유지 (현재는 앱이 계속 실행되도록만 처리)

### 4. 🟢 경미: 성능 최적화 여지
**문제**: 대용량 데이터 시 리시딩 시간 증가 가능
**영향**: 현재 데이터 규모에서는 문제없으나, 향후 확장 시 고려 필요
**권장**: 프로그레스 바 표시 및 백그라운드 처리 개선

---

## ✨ 개선 사항 적용 완료

### 1. build.gradle.kts
```diff
- versionCode = 1
+ versionCode = 1  // TODO: 앱 업데이트 시마다 반드시 증가시킬 것!
+ versionName = "1.0"  // TODO: 사용자용 버전
```

### 2. chords_seed_by_root.json
```json
{
  "_metadata": {
    "version": "20250101",
    "description": "PocketChord seed data organized by root note",
    "lastUpdated": "2025-01-01",
    "totalRoots": 12
  },
  ...
}
```

### 3. SeedImporter.kt 개선
- 메타데이터 검증 추가
- 상세한 로깅 (시작/진행/완료)
- `_metadata` 항목 스킵 처리
- 성능 측정 (elapsed time)
- 에러 레벨 구분 (Log.e)

### 4. 문서 작성
- `docs/update-checklist.md`: 업데이트 절차 가이드
- 이 보고서: 전체 시스템 검토 결과

---

## 📊 현재 설정의 적합성 평가

### ✅ 적합한 점

1. **서버리스 아키텍처**
   - 소규모 앱에 적합
   - 유지보수 비용 제로
   - 오프라인 완전 지원

2. **versionCode 기반 트리거**
   - 구글 플레이 스토어 배포 프로세스와 자연스럽게 통합
   - 명확한 업데이트 시점
   - 중복 실행 방지

3. **전체 재시딩 전략**
   - 데이터 일관성 보장
   - 구현 단순함
   - 데이터 크기가 작으면 성능 문제 없음

4. **Natural Key 기반 즐겨찾기 보존**
   - 사용자 데이터 유실 방지
   - 안정적인 복원

### ⚠️ 제한 사항

1. **스케일링 한계**
   - 현재: 12개 루트 × ~10개 코드 = ~120개 엔트리 (매우 적음)
   - 향후 1000+ 코드로 확장 시: 리시딩 시간 증가
   - 권장: 10만개 이하 유지 or 증분 업데이트 도입

2. **APK 크기**
   - JSON 파일이 APK에 포함
   - 현재: ~10KB (무시 가능)
   - 향후: 1MB 이상 시 동적 다운로드 고려

3. **업데이트 강제성**
   - 앱 업데이트 없이는 데이터 갱신 불가
   - 긴급 데이터 수정 시 대응 지연
   - 대안: 선택적 원격 업데이트 (향후)

---

## 🎯 권장 사항

### 즉시 적용 (완료)
- [x] versionCode 업데이트 주석 추가
- [x] JSON 메타데이터 구조 추가
- [x] 로깅 개선
- [x] 업데이트 가이드 문서 작성

### 단기 (1-2개월 내)
- [ ] JSON 스키마 검증 자동화 (단위 테스트)
- [ ] 리시딩 프로그레스 UI 추가
- [ ] CI/CD에 versionCode 자동 증가 스크립트 통합

### 중기 (3-6개월 내)
- [ ] 리시딩 실패 시 롤백 메커니즘
- [ ] 데이터 규모 모니터링
- [ ] 성능 테스트 (1000+ 코드)

### 장기 (필요 시)
- [ ] 증분 업데이트 지원 (diff 패치)
- [ ] 선택적 원격 업데이트 (앱 업데이트 없이)
- [ ] 압축 형식 도입 (Protobuf/MsgPack)

---

## 📈 데이터 규모별 전략

| 데이터 규모 | 현재 전략 적합성 | 권장 조치 |
|------------|----------------|----------|
| < 1,000개 | ✅ 완벽 | 현재 유지 |
| 1,000 - 10,000개 | ✅ 적합 | 프로그레스 UI 추가 |
| 10,000 - 100,000개 | ⚠️ 주의 | 증분 업데이트 검토 |
| > 100,000개 | ❌ 부적합 | 원격 DB + 동기화 |

**현재 규모**: ~120개 ✅ 매우 적합

---

## 🔒 위험 관리

### 리스크 매트릭스

| 리스크 | 확률 | 영향 | 대응 |
|--------|------|------|------|
| versionCode 증가 누락 | 중 | 높음 | 체크리스트 + CI 검증 |
| JSON 문법 오류 | 중 | 높음 | 자동 검증 테스트 |
| 리시딩 실패 | 낮 | 중간 | 에러 핸들링 개선 |
| APK 크기 증가 | 낮 | 낮음 | 모니터링 |

### 백업 전략
- SharedPreferences에 마지막 성공 버전 저장 (현재 구현됨)
- Room DB 자체가 영구 저장소 역할
- 사용자 데이터(즐겨찾기)는 natural key로 복원

---

## ✅ 결론

### 종합 평가: **적합함 (B+)**

**강점:**
- 현재 데이터 규모에 최적화됨
- 구현이 단순하고 안정적
- 오프라인 완전 지원
- 유지보수 비용 최소

**개선 필요:**
- versionCode 관리 프로세스 명확화 (완료)
- 검증 및 모니터링 강화 (진행 중)
- 향후 확장성 대비

**최종 권고:**
현재 체계를 유지하되, 다음을 준수:
1. **필수**: 매 업데이트 시 versionCode 증가
2. **필수**: JSON 파일 검증 후 배포
3. **권장**: 업데이트 체크리스트 활용
4. **권장**: 데이터 규모 1,000개 이상 시 재검토

---

## 📚 참고 문서
- `docs/update-checklist.md`: 업데이트 절차 가이드
- `docs/chords-db-architecture.md`: DB 아키텍처
- `docs/chords-seed-format.md`: JSON 스키마 정의

---

**검토자**: GitHub Copilot  
**최종 업데이트**: 2025-01-01  
**다음 검토 권장일**: 데이터 규모 10배 증가 시 또는 6개월 후

