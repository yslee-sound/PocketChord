-- ============================================
-- Phase 2: emergency_policy í…Œì´ë¸” ìƒì„±
-- ì‘ì„±ì¼: 2025-11-09
-- ëª©ì : ê¸´ê¸‰ ìƒí™© ë¶„ë¦¬ ë° Google Play ì •ì±… ì¤€ìˆ˜
-- ============================================

-- 0. ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ (ìˆìœ¼ë©´)
DROP TABLE IF EXISTS public.emergency_policy CASCADE;

-- 1. emergency_policy í…Œì´ë¸” ìƒì„±
CREATE TABLE public.emergency_policy (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- ê¸°ë³¸ ì •ë³´
    app_id TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- ê¸´ê¸‰ ë©”ì‹œì§€
    content TEXT NOT NULL,
    redirect_url TEXT,          -- Play Store ë§í¬ ë“±
    button_text TEXT NOT NULL DEFAULT 'í™•ì¸',  -- ë²„íŠ¼ í…ìŠ¤íŠ¸

    -- ===== Google Play ì •ì±… ì¤€ìˆ˜ (í•µì‹¬!) =====
    is_dismissible BOOLEAN NOT NULL DEFAULT TRUE,

    CONSTRAINT emergency_policy_pkey PRIMARY KEY (id)
);

-- 2. ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_emergency_policy_app_id ON public.emergency_policy(app_id);
CREATE INDEX idx_emergency_policy_active ON public.emergency_policy(is_active);

-- ì•±ë‹¹ 1ê°œì˜ í™œì„± ê¸´ê¸‰ ìƒí™©ë§Œ í—ˆìš© (partial unique index)
CREATE UNIQUE INDEX idx_emergency_policy_unique_active
ON public.emergency_policy(app_id)
WHERE is_active = true;

-- 3. RLS ì •ì±… ì„¤ì •
ALTER TABLE public.emergency_policy ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allow_read_emergency_policy"
ON public.emergency_policy
FOR SELECT
USING (true);

-- 4. ì½”ë©˜íŠ¸ ì¶”ê°€
COMMENT ON TABLE public.emergency_policy IS 'ê¸´ê¸‰ ìƒí™© íŒì—… ì •ì±… (ì•± ì°¨ë‹¨, ì„œë¹„ìŠ¤ ì¢…ë£Œ ë“±)';
COMMENT ON COLUMN public.emergency_policy.is_dismissible IS 'X ë²„íŠ¼ í—ˆìš© ì—¬ë¶€ (ê¸°ë³¸ê°’ true, falseëŠ” ìµœí›„ì˜ ìˆ˜ë‹¨)';
COMMENT ON COLUMN public.emergency_policy.redirect_url IS 'Play Store ë§í¬ (ìƒˆ ì•± ì„¤ì¹˜ ìœ ë„)';
COMMENT ON COLUMN public.emergency_policy.button_text IS 'ë²„íŠ¼ í…ìŠ¤íŠ¸ (ì˜ˆ: "ìƒˆ ì•± ì„¤ì¹˜í•˜ê¸°", "í™•ì¸", "ìì„¸íˆ ë³´ê¸°")';
COMMENT ON COLUMN public.emergency_policy.content IS 'ê¸´ê¸‰ ë©”ì‹œì§€ ë‚´ìš©';

-- 5. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚½ì… (ë¹„í™œì„±í™” ìƒíƒœ)
-- ì‹¤ì œ ê¸´ê¸‰ ìƒí™©ì´ ì•„ë‹ˆë¯€ë¡œ is_active = false
INSERT INTO public.emergency_policy (
    app_id,
    is_active,
    content,
    redirect_url,
    button_text,
    is_dismissible
) VALUES (
    'com.sweetapps.pocketchord',
    false,  -- ë¹„í™œì„±í™” (í…ŒìŠ¤íŠ¸ìš©)
    'âš ï¸ [í…ŒìŠ¤íŠ¸] ì´ ì•±ì€ ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nìƒˆ ë²„ì „ì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.',
    NULL,  -- ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ í•„ìš”!
    'í™•ì¸',
    true    -- X ë²„íŠ¼ í—ˆìš© (Google Play ì •ì±… ì¤€ìˆ˜)
);

-- í…ŒìŠ¤íŠ¸ìš© debug ë°ì´í„°
INSERT INTO public.emergency_policy (
    app_id,
    is_active,
    content,
    redirect_url,
    button_text,
    is_dismissible
) VALUES (
    'com.sweetapps.pocketchord.debug',
    false,  -- ë¹„í™œì„±í™” (í…ŒìŠ¤íŠ¸ ì‹œ ìˆ˜ë™ìœ¼ë¡œ í™œì„±í™”)
    'ğŸš¨ [DEBUG] ê¸´ê¸‰ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.\nì´ê²ƒì€ ë””ë²„ê·¸ìš© íŒì—…ì…ë‹ˆë‹¤.',
    NULL,  -- ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ í•„ìš”!
    'í™•ì¸',
    true    -- X ë²„íŠ¼ í—ˆìš©
);

-- ì™„ë£Œ!
SELECT 'emergency_policy í…Œì´ë¸” ìƒì„± ì™„ë£Œ!' as status;

